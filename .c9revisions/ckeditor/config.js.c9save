{"ts":1376826724260,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"CKEDITOR.on('instanceReady', function( ev ) {\n    //инитим кнопки\n    var obj = new editor();\n    obj.prepareTezis();\n    obj.preparePhotoDialog();\n\n\n    //устанвливаем чтобы всегда выводились скроллы для редактора\n    if ($.browser.msie && (parseInt($.browser.version) == 7 || parseInt($.browser.version) == 8)) {\n        $('#field_noteeditor').css('overflow-y', 'scroll');\n        $('#cke_contents_field_noteeditor').css('width', '580px');\n    } else {\n        $(ev.editor.document['$']).find('body').css('overflow-y', 'scroll');\n    }\n\n\n    //запрещаем добавление лишних новых строк и отступов внутри исходного html\n    var blockTags = ['div','h1','h2','h3','h4','h5','h6','p','pre','li','blockquote','ul','ol',\n        'table','thead','tbody','tfoot','td','th'];\n\n    for (var i = 0; i < blockTags.length; i++)\n    {\n        ev.editor.dataProcessor.writer.setRules( blockTags[i], {\n        indent : false,\n        breakBeforeOpen : true,\n        breakAfterOpen : false,\n        breakBeforeClose : false,\n        breakAfterClose : true\n        });\n    }\n\n    /**\n     * запрещаем удалять div-ы c помощью кнопок delete и backspace\n     */\n/*\n    ev.editor.on(\"key\", function (e) {\n        var ranges,curRange,boundaryNodes;\n\n        if(e.data.keyCode == 8){ //backspace\n            ranges = e.editor.getSelection().getRanges();\n            curRange = ranges[0];\n\n            boundaryNodes = curRange.getBoundaryNodes();\n\n            if (curRange.startOffset == 0 && curRange.endOffset == curRange.startOffset\n                && curRange.startContainer[\"$\"] == curRange.endContainer[\"$\"]) {\n\n                if ( \"div\" == $(boundaryNodes.startNode[\"$\"]).parent().prev().children(\":first\").get(0).nodeName.toLowerCase()){\n                    e.cancel();\n                }\n            }\n\n            return false;\n        } else if (e.data.keyCode == 46){//delete\n\n            ranges = e.editor.getSelection().getRanges();\n            curRange = ranges[0];\n\n            boundaryNodes = curRange.getBoundaryNodes();\n\n            if (curRange.startOffset == curRange.startContainer[\"$\"].length\n                && curRange.endOffset == curRange.startOffset\n                && curRange.startContainer[\"$\"] == curRange.endContainer[\"$\"]\n                && typeof $(boundaryNodes.endNode[\"$\"]).parent().next().children(\":first\").get(0) != \"undefined\"\n                && \"div\" == $(boundaryNodes.endNode[\"$\"]).parent().next().children(\":first\").get(0).nodeName.toLowerCase()\n                || typeof $(boundaryNodes.endNode[\"$\"]).next().children().get(1) != \"undefined\"\n                && \"div\" == $(boundaryNodes.endNode[\"$\"]).next().children().get(1).nodeName.toLowerCase()) {\n\n                    e.cancel();\n            }\n\n            return false;\n\n        //обработка нажатий курсорных клавиш чтобы в ИЕ не заходил внутрь блоков div\n        //обработку нужно вызвать через какое-то время, чтобы курсор оказался внутри блока\n        } else if (e.data.keyCode == 39 || e.data.keyCode == 40){//right & down arrows\n            var fCharTimeout;\n\n            var forwardHandler = function(){\n                if(checkIsCarrierInDiv(e)){\n                    if(!moveCarrierToNextParagraph(e)){\n                        moveCarrierToPrevParagraph(e);\n                    }\n                }\n\n            };\n\n            if(fCharTimeout){\n                clearTimeout(fCharTimeout);\n            }\n\n            fCharTimeout = setTimeout(forwardHandler, 50);\n        } else if (e.data.keyCode == 37 || e.data.keyCode == 38){//left & up arrows\n            var bCharTimeout;\n\n            var bakcwardHandler = function(){\n                if(checkIsCarrierInDiv(e)){\n                    if(!moveCarrierToPrevParagraph(e)){\n                        moveCarrierToNextParagraph(e);\n                    }\n                }\n\n            };\n\n            if(bCharTimeout){\n                clearTimeout(bCharTimeout);\n            }\n\n            bCharTimeout = setTimeout(bakcwardHandler, 10);\n        }\n    });\n*/\n\n    //убираем пустые теги P вокруг DIV\n    ev.editor.on('clearEmptyP', function(ev){\n        //trace('clearEmptyP');\n        //trace(ev.editor.document.getBody().getHtml());\n\n        if(CKEDITOR.env.ie){//для IE вычищаем _</placeholder>\n            ev.editor.document.getBody().setHtml(\n                ev.editor.document.getBody().getHtml().replace(/_?<\\/placeholder>/ig, \"\")\n            );\n        }\n\n        var divs = ev.editor.document.getElementsByTag(\"div\"), el;\n\n        for (var i = divs.count()-1; i >= 0; i--) {\n            el = divs.getItem(i);\n            if(el.getParent().getName().toLowerCase() == \"body\"){\n                if (el.hasPrevious() && el.getPrevious().hasOwnProperty(\"getName\") && el.getPrevious().getName().toLowerCase() == \"p\" && el.getPrevious().getText() == \"\"){\n                    el.getPrevious().remove();\n                }\n\n                if (el.hasNext() && el.getNext().hasNext() && el.getNext().hasOwnProperty(\"getName\") && el.getNext().getName().toLowerCase() == \"p\" && el.getPrevious().getText() == \"\"){\n                    el.getPrevious().remove();\n                }\n            }\n\n        }\n\n        ev.editor.fire(\"rtUpdateControls\");\n\n        $('.noSelect', ev.editor.document[\"$\"]).disableTextSelect();//No text selection on elements with a class of 'noSelect'\n    });\n\n    ev.editor.fire(\"clearEmptyP\");\n\n    ev.editor.on(\"getData\", function(){\n        ev.editor.fire(\"clearEmptyP\");\n    });\n});\n\n\n/**\n * @param event CKEDITOR.event\n */\nfunction checkIsCarrierInDiv(event){\n    var inDiv = false;\n\n    var selection = event.editor.getSelection();\n    var ranges = selection.getRanges();\n    var nodes = ranges[0].getBoundaryNodes();\n    var parents = nodes.startNode.getParents(true);\n\n    $.each(parents, function( index, el){\n        if(el[\"$\"].nodeName.toLowerCase() == \"div\"){\n            inDiv = true;\n        }\n    });\n\n    return inDiv;\n}\n\n/**\n * @param event CKEDITOR.event\n */\nfunction moveCarrierToNextParagraph(event){\n    var moved = false;\n    var selection = event.editor.getSelection();\n    var ranges = selection.getRanges();\n    var nodes = ranges[0].getBoundaryNodes();\n    var parents = nodes.startNode.getParents(true);\n\n    var prevEl;\n\n    $.each(parents, function( index, el){\n        if(el[\"$\"].nodeName.toLowerCase() == \"body\"){\n            ranges[0].setStartAt(prevEl.getNext(), CKEDITOR.POSITION_AFTER_START);\n            ranges[0].setEndAt(prevEl.getNext(), CKEDITOR.POSITION_AFTER_START);\n            selection.selectRanges(ranges);\n            moved = true;\n        }\n        prevEl = el;\n\n    });\n\n    return moved;\n}\n\n/**\n * @param event CKEDITOR.event\n */\nfunction moveCarrierToPrevParagraph(event){\n    var moved = false;\n    var selection = event.editor.getSelection();\n    var ranges = selection.getRanges();\n    var nodes = ranges[0].getBoundaryNodes();\n    var parents = nodes.endNode.getParents(true);\n\n    var prevEl;\n\n    $.each(parents, function( index, el){\n        if(el[\"$\"].nodeName.toLowerCase() == \"body\"){\n            ranges[0].setStartAt(prevEl.getPrevious(), CKEDITOR.POSITION_BEFORE_END);\n            ranges[0].setEndAt(prevEl.getPrevious(), CKEDITOR.POSITION_BEFORE_END);\n            selection.selectRanges(ranges);\n            moved = true;\n        }\n        prevEl = el;\n    });\n\n    return moved;\n}"]],"start1":0,"start2":0,"length1":0,"length2":7294}]],"length":7294}
{"contributors":[],"silentsave":false,"ts":1377334640879,"patch":[[{"diffs":[[0,"t'\n    });\n\n    "],[1,"//"],[0,"ev.editor.fire(\""]],"start1":5297,"start2":5297,"length1":32,"length2":34}]],"length":7296,"saved":false}
{"ts":1377334692692,"patch":[[{"diffs":[[0,"ого html\n   "],[1," //"],[0," var blockTa"]],"start1":610,"start2":610,"length1":24,"length2":27},{"diffs":[[0,"l','ol',\n   "],[1," //"],[0,"     'table'"]],"start1":709,"start2":709,"length1":24,"length2":27},{"diffs":[[0,"'];\n\n   "],[1," //"],[0," for (va"]],"start1":769,"start2":769,"length1":16,"length2":19},{"diffs":[[0,"i++)\n   "],[1," //"],[0," {\n   "],[1," //"],[0,"     ev."]],"start1":819,"start2":819,"length1":22,"length2":28},{"diffs":[[0,"gs[i], {\n   "],[1," //"],[0,"     indent "]],"start1":892,"start2":892,"length1":24,"length2":27},{"diffs":[[0,"ent : false,\n   "],[1," //"],[0,"     breakBefore"]],"start1":915,"start2":915,"length1":32,"length2":35},{"diffs":[[0,": true,\n    "],[1,"//"],[0,"    "],[1," "],[0,"breakAfterOp"]],"start1":955,"start2":955,"length1":28,"length2":31},{"diffs":[[0,"pen : false,\n   "],[1," //"],[0,"     breakBefore"]],"start1":985,"start2":985,"length1":32,"length2":35},{"diffs":[[0,": false,\n   "],[1," //"],[0,"     breakAf"]],"start1":1026,"start2":1026,"length1":24,"length2":27},{"diffs":[[0,"e : true\n   "],[1," //"],[0,"     });\n   "]],"start1":1060,"start2":1060,"length1":24,"length2":27},{"diffs":[[0,"     });\n   "],[1," //"],[0," }\n\n    /**\n"]],"start1":1075,"start2":1075,"length1":24,"length2":27}]],"length":7332,"saved":false}
{"ts":1377334737590,"patch":[[{"diffs":[[0,"arEmptyP"],[1,"1"],[0,"', funct"]],"start1":4086,"start2":4086,"length1":16,"length2":17}]],"length":7333,"saved":false}
{"ts":1377334817316,"patch":[[{"diffs":[[0,"html\n   "],[-1," //"],[0," var blo"]],"start1":614,"start2":614,"length1":19,"length2":16},{"diffs":[[0,"l','ol',\n   "],[-1," //"],[0,"     'table'"]],"start1":706,"start2":706,"length1":27,"length2":24},{"diffs":[[0,"'];\n\n   "],[-1," //"],[0," for (va"]],"start1":763,"start2":763,"length1":19,"length2":16},{"diffs":[[0,"\n   "],[-1," //"],[0," {\n   "],[-1," //"],[0,"    "]],"start1":814,"start2":814,"length1":20,"length2":14},{"diffs":[[0,"gs[i], {\n   "],[-1," //"],[0,"     indent "]],"start1":877,"start2":877,"length1":27,"length2":24},{"diffs":[[0,"ent : false,\n   "],[-1," //"],[0,"     breakBefore"]],"start1":897,"start2":897,"length1":35,"length2":32},{"diffs":[[0,": true,\n    "],[-1,"//"],[0,"    "],[-1," "],[0,"breakAfterOp"]],"start1":934,"start2":934,"length1":31,"length2":28},{"diffs":[[0,"pen : false,\n   "],[-1," //"],[0,"     breakBefore"]],"start1":961,"start2":961,"length1":35,"length2":32},{"diffs":[[0,": false,\n   "],[-1," //"],[0,"     breakAf"]],"start1":999,"start2":999,"length1":27,"length2":24},{"diffs":[[0,"true\n   "],[-1," //"],[0,"     });"]],"start1":1034,"start2":1034,"length1":19,"length2":16},{"diffs":[[0," });\n   "],[-1," //"],[0," }\n\n    "]],"start1":1046,"start2":1046,"length1":19,"length2":16},{"diffs":[[0,"arEmptyP"],[-1,"1"],[0,"', funct"]],"start1":4050,"start2":4050,"length1":17,"length2":16},{"diffs":[[0,");\n\n    "],[-1,"//"],[0,"ev.edito"]],"start1":5305,"start2":5305,"length1":18,"length2":16}]],"length":7294,"saved":false}
{"ts":1377335908006,"patch":[[{"diffs":[[0,"( ev ) {"],[1," return;"],[0,"\n    //и"]],"start1":37,"start2":37,"length1":16,"length2":24}]],"length":7302,"saved":false}
{"ts":1377335928336,"patch":[[{"diffs":[[0,") { "],[-1,"return;"],[0,"\n   "]],"start1":42,"start2":42,"length1":15,"length2":8},{"diffs":[[0,"ditor();"],[1," return;"],[0,"\n    obj"]],"start1":86,"start2":86,"length1":16,"length2":24}]],"length":7303,"saved":false}
{"ts":1377335939596,"patch":[[{"diffs":[[0,"(); "],[-1,"return;"],[0,"\n   "]],"start1":91,"start2":91,"length1":15,"length2":8},{"diffs":[[0,"alog();\n"],[1,"return;"],[0,"\n\n    //"]],"start1":142,"start2":142,"length1":16,"length2":23}]],"length":7303,"saved":false}
{"ts":1377335941324,"patch":[[{"diffs":[[0,"();\n"],[-1,"return;"],[0,"\n\n  "]],"start1":146,"start2":146,"length1":15,"length2":8}]],"length":7296,"saved":false}
