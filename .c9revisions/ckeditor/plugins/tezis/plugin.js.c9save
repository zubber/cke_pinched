{"ts":1377416593570,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"$(document).ready(function(){\r\n\r\n    /**\r\n     * Создаем плагин для добавления тезиса к заметке\r\n     */\r\n    CKEDITOR.plugins.add( 'tezis', {\r\n        \r\n        /**\r\n         * При инициализации всего ckeditor заходим сюда \r\n         * PS: до загрузки данных и отображения\r\n         */\r\n        init : function( editor ) {\r\n            \r\n            /**\r\n             * Создаем команду для тулбара\r\n             * открывает диалог и посылает команду для добавления контента\r\n             */\r\n            editor.addCommand('rt_cmd_dialog_tezis', {\r\n                \r\n                exec: function (editor, data) {\r\n                    \r\n                    // определяем текущий элемент\r\n                    var sel = editor.getSelection(),\r\n                    element = sel.getStartElement();\r\n                    var insertMode;\r\n                    var tezis;\r\n                    \r\n                    // редактирование или добавление\r\n                    if (isDefined(data)) {\r\n                        \r\n                        tezis = $(data);\r\n                        if (!tezis.hasClass('line_head')) {\r\n                            \r\n                            tezis = tezis.parents('.line_head');\r\n                        }\r\n                        insertMode = false;\r\n                    } else if (element) {\r\n                        \r\n                        if ($(element['$']).hasClass('line_head')) {\r\n                            \r\n                            tezis = $(element['$']);\r\n                        } else {\r\n                            \r\n                            tezis = $(element['$']).parents('.line_head');\r\n                        }\r\n                        \r\n                        insertMode = element.data( 'cke-realelement' ) || !tezis.size();\r\n                    } else {\r\n                        \r\n                        insertMode = true;\r\n                    }\r\n                    \r\n                    if (insertMode) {\r\n                        \r\n                        // инициализация полей диалога значениями по умолчанию\r\n                        $('#' + editor.name).trigger('showTezis', [function(message){\r\n                            \r\n                            if ($.trim(message).length) {\r\n                                \r\n                                // посылаем команду для добавления контента\r\n                                editor.execCommand('rt_cmd_tezis', [message]);\r\n                            }\r\n                        }, '']);\r\n                    } else {\r\n                        \r\n                        // инициализация полей диалога значениями из текущего элемента\r\n                        $('#' + editor.name).trigger('showTezis', [function(message){\r\n                            \r\n                            if ($.trim(message).length) {\r\n                                \r\n                                tezis.find('p').text(message);\r\n                            }\r\n                        }, tezis.find('p').text()]);\r\n                    }\r\n                }\r\n            });\r\n            \r\n            /**\r\n             * Событие для обработки нажатия по клавише Редактировать\r\n             * PS: нужно инициализировать при добавлении нового и открытии сохраненного\r\n             */\r\n            var editClick = function(){\r\n                \r\n                editor.execCommand('rt_cmd_dialog_tezis', [this]);\r\n                return false;\r\n            };\r\n            \r\n            /**\r\n             * Событие для обработки нажатия по клавише Удалить\r\n             * PS: нужно инициализировать при добавлении нового и открытии сохраненного\r\n             */\r\n            var delClick = function(){\r\n                \r\n                var element = $(this).parents('.line_head');\r\n                confirm('Вы действительно хотите удалить данный тезис?', function(result){\r\n                    \r\n                    if (result) {\r\n                        \r\n                        element.remove();\r\n                    }\r\n                }, undefined, undefined, 'Создание заметки');\r\n                return false;\r\n            };\r\n            \r\n            /**\r\n             * Функция для верстки редактирования\r\n             */\r\n            var editHTML = function(message) {\r\n\r\n                return '<div contenteditable=\"false\" class=\"line_head\">\\\r\n                            <div contenteditable=\"false\" class=\"vn\">\\\r\n                                <div contenteditable=\"false\" class=\"buttons\">\\\r\n                                    <span contenteditable=\"false\" class=\"del\">&nbsp;</span>\\\r\n                                    <span contenteditable=\"false\" class=\"edit\">&nbsp;</span>\\\r\n                                </div>\\\r\n                                <p contenteditable=\"false\">' + message + '</p>\\\r\n                            </div>\\\r\n                        </div>';\r\n            };\r\n            \r\n            /**\r\n             * Функция для верстки просмотра\r\n             */\r\n            var previewHTML = function(message) {\r\n                \r\n                return '<placeholder type=\"tezis\" value=\"' + message.replace(/\"/g, '\\\\\"') + '\">_</placeholder>';\r\n            };\r\n            \r\n            /**\r\n             * Функция для назначения событий на клавиши\r\n             */\r\n            var setEditEvents = function (document) {\r\n                $(document).find('.line_head').unbind('click').click(editClick).not('.del').unbind('click').click(editClick).end().find('.del').unbind('click').click(delClick);\r\n            };\r\n            \r\n            /**\r\n             * Функция для подготовки верстки редактирования тезисов\r\n             */\r\n            var prepareEditHTML = function (document) {\r\n                \r\n                // подменяем верстку - старый вариант\r\n                var blockquotes = $(document[\"$\"]).find('blockquote');\r\n\r\n                blockquotes.find('span').each(function(index, element){\r\n                    $(element).parents('blockquote').before(editHTML($(element).text()));\r\n                });\r\n\r\n                blockquotes.empty();\r\n                blockquotes.remove();\r\n\r\n                //плейсхолдеры\r\n                //находим все блоки тезисов, сейчас они в внутреннем виде\r\n                var placeholders = document.getElementsByTag(\"placeholder\");\r\n                var el;\r\n\r\n                //для каждого\r\n                for (var i = placeholders.count()-1; i >= 0; i--) {\r\n                    el = placeholders.getItem(i);\r\n\r\n                    if(el.getAttribute(\"type\") != \"tezis\"){\r\n                        continue;\r\n                    }\r\n\r\n                    //выдираем нужные нам параметры из вёрстки\r\n                    var value = el.getAttribute('value');\r\n\r\n                    //заменяем блоки\r\n                    $(el['$']).replaceWith(editHTML(value));\r\n                }\r\n\r\n            };\r\n            \r\n            /**\r\n             * Функция для подготовки верстки просмотра тезисов\r\n             */\r\n            var preparePreviewHTML = function (document) {\r\n                \r\n                // подменяем верстку\r\n                var lineHeads = $(document).find('.line_head');\r\n                lineHeads.find('p').each(function(index, element){\r\n\r\n                    var parent = $(element).parents('.line_head');\r\n                    parent.replaceWith(previewHTML($(element).text()));\r\n\r\n                });\r\n                //lineHeads.remove();\r\n            };\r\n            \r\n            /**\r\n             * Создаем команду для добавления контента\r\n             */\r\n            editor.addCommand('rt_cmd_tezis', {\r\n                \r\n                exec: function(editor, data) {\r\n                    \r\n                    // добавляем в текущее место блок с тезисом\r\n                    editor.insertHtml(editHTML(data));\r\n                    setEditEvents(editor.document['$']);\r\n                }\r\n            });\r\n            \r\n            /**\r\n             * Добавляем клавишу для тулбара, нажатие по которой заставит открыть диалог\r\n             */\r\n            editor.ui.addButton('rtTezis', {\r\n                icon    : '/i/ico_btn_line.gif',\r\n                label   : 'Вставить тезис',\r\n                command : 'rt_cmd_dialog_tezis'\r\n            });\r\n            \r\n            /**\r\n             * Настраиваем попап-меню по клику на правую клавишу мыши\r\n             */\r\n            if (editor.contextMenu) {\r\n                \r\n                // по нажатию будет открывать диалог\r\n                editor.addMenuGroup('rutraveller');\r\n                editor.addMenuItem('tezisItem', {\r\n                    label   : 'Редактировать',\r\n                    icon    : '/i/ico_ne_edit.gif',\r\n                    command : 'rt_cmd_dialog_tezis',\r\n                    group   : 'rutraveller'\r\n                });\r\n                \r\n                // настраиваем место, клик по которому покажет меню Редактировать\r\n                editor.contextMenu.addListener( function( element ) {\r\n                    \r\n                    if (element) {\r\n                        \r\n                        element = ($(element['$']).hasClass('line_head') || $(element['$']).parents('.line_head').size()) && !element.data('cke-realelement');\r\n                    }\r\n                    \r\n                    if (element) {\r\n                        \r\n                        return {tezisItem : CKEDITOR.TRISTATE_OFF};\r\n                    }\r\n                    \r\n                    return null;\r\n                });\r\n            }\r\n            \r\n            /**\r\n             * Создаем клавиши и назначаем события на них\r\n             * PS: сюда приходит уже после добавления данных в элемент\r\n             */\r\n            editor.on('instanceReady', function(e){\r\n                \r\n                if (isDefined(e.editor.document)) {\r\n                    \r\n                    prepareEditHTML(e.editor.document);\r\n                    setEditEvents(e.editor.document['$']);\r\n                }\r\n            });\r\n\r\n\r\n            /**\r\n             * Сигнал на обновление контролов\r\n             */\r\n            editor.on('rtUpdateControls', function(e){\r\n                setEditEvents(e.editor.document['$']);\r\n            });\r\n\r\n\r\n            /**\r\n             * возвращаем события при Ctrl-Z\r\n             */\r\n            editor.on('key', function(e){\r\n                if (isDefined(e.editor.document) && CKEDITOR.CTRL + 90 == e.data.keyCode) {//Ctrl-Z\r\n                    setTimeout(function(){\r\n                        setEditEvents(e.editor.document['$'])\r\n                    }, 100);\r\n                }\r\n            });\r\n\r\n            /**\r\n             * Перед тем как отдать данные удаляем клавиши из контента\r\n             */\r\n            editor.on('beforeGetData', function(e){\r\n                \r\n                if (isDefined(e.editor.document)) {\r\n                    \r\n                    preparePreviewHTML(e.editor.document['$']);\r\n                }\r\n            });\r\n            \r\n            /**\r\n             * После того как данные отдали, возвращаем клавишии на место\r\n             */\r\n            editor.on('getData', function(e){\r\n                \r\n                // находим клавиши и инициализируем события клика по ним\r\n                if (isDefined(e.editor.document)) {\r\n                    \r\n                    prepareEditHTML(e.editor.document);\r\n                    setEditEvents(e.editor.document['$']);\r\n                }\r\n            });\r\n        }\r\n    });\r\n});"]],"start1":0,"start2":0,"length1":0,"length2":11491}]],"length":11491}
{"contributors":[],"silentsave":false,"ts":1377416733217,"patch":[[{"diffs":[[0,"tor.addCommand('"],[-1,"rt"],[1,"pl"],[0,"_cmd_dialog_tezi"]],"start1":508,"start2":508,"length1":34,"length2":34},{"diffs":[[0,"or.execCommand('"],[-1,"rt"],[1,"pl"],[0,"_cmd_tezis', [me"]],"start1":2402,"start2":2402,"length1":34,"length2":34},{"diffs":[[0,"xecCommand('"],[-1,"rt"],[1,"pl"],[0,"_cmd_dialog_"]],"start1":3364,"start2":3364,"length1":26,"length2":26},{"diffs":[[0,"ommand('"],[-1,"rt"],[1,"pl"],[0,"_cmd_tez"]],"start1":7594,"start2":7594,"length1":18,"length2":18},{"diffs":[[0,"Button('"],[-1,"rt"],[0,"Tezis', "]],"start1":8086,"start2":8086,"length1":18,"length2":16},{"diffs":[[0,"     command : '"],[-1,"rt"],[1,"pl"],[0,"_cmd_dialog_tezi"]],"start1":8211,"start2":8211,"length1":34,"length2":34},{"diffs":[[0,"mand : '"],[-1,"rt"],[1,"pl"],[0,"_cmd_dia"]],"start1":8724,"start2":8724,"length1":18,"length2":18}]],"length":11489,"saved":false}
{"ts":1377416896879,"patch":[[{"diffs":[[0,"\n           "],[1," //"],[0," if (editor."]],"start1":8384,"start2":8384,"length1":24,"length2":27},{"diffs":[[0,"   \r\n           "],[1," //"],[0,"     // по нажат"]],"start1":8440,"start2":8440,"length1":32,"length2":35},{"diffs":[[0,"ог\r\n            "],[1,"//"],[0,"    "],[1," "],[0,"editor.addMenuGr"]],"start1":8498,"start2":8498,"length1":36,"length2":39},{"diffs":[[0,"');\r\n           "],[1," //"],[0,"     editor.addM"]],"start1":8553,"start2":8553,"length1":32,"length2":35},{"diffs":[[0,", {\r\n           "],[1," //"],[0,"         label  "]],"start1":8607,"start2":8607,"length1":32,"length2":35},{"diffs":[[0,"ь',\r\n           "],[1," //"],[0,"         icon   "]],"start1":8658,"start2":8658,"length1":32,"length2":35},{"diffs":[[0,"f',\r\n           "],[1," //"],[0,"         command"]],"start1":8714,"start2":8714,"length1":32,"length2":35},{"diffs":[[0,"        "],[1,"//"],[0,"        "],[1," "],[0,"group   "]],"start1":8780,"start2":8780,"length1":24,"length2":27},{"diffs":[[0,"er'\r\n           "],[1," //"],[0,"     });\r\n      "]],"start1":8819,"start2":8819,"length1":32,"length2":35},{"diffs":[[0,"   \r\n           "],[1," //"],[0,"     // настраив"]],"start1":8861,"start2":8861,"length1":32,"length2":35},{"diffs":[[0,"ать\r\n           "],[1," //"],[0,"     editor.cont"]],"start1":8947,"start2":8947,"length1":32,"length2":35},{"diffs":[[0,"   \r\n           "],[1," //"],[0,"         if (ele"]],"start1":9043,"start2":9043,"length1":32,"length2":35},{"diffs":[[0,"  \r\n            "],[1,"//"],[0,"            elem"]],"start1":9109,"start2":9109,"length1":32,"length2":34},{"diffs":[[0,"  //            "],[1," "],[0,"element = ($(ele"]],"start1":9123,"start2":9123,"length1":32,"length2":33},{"diffs":[[0,"');\r\n           "],[1," //"],[0,"         }\r\n    "]],"start1":9271,"start2":9271,"length1":32,"length2":35},{"diffs":[[0,"   \r\n           "],[1," //"],[0,"         if (ele"]],"start1":9319,"start2":9319,"length1":32,"length2":35},{"diffs":[[0,"   \r\n           "],[1," //"],[0,"             ret"]],"start1":9384,"start2":9384,"length1":32,"length2":35},{"diffs":[[0,"F};\r\n           "],[1," //"],[0,"         }\r\n    "]],"start1":9456,"start2":9456,"length1":32,"length2":35},{"diffs":[[0,"            "],[1,"//"],[0,"        "],[1," "],[0,"return null;"]],"start1":9509,"start2":9509,"length1":32,"length2":35},{"diffs":[[0,"ll;\r\n           "],[1," //"],[0,"     });\r\n      "]],"start1":9541,"start2":9541,"length1":32,"length2":35},{"diffs":[[0,"});\r\n           "],[1," //"],[0," }\r\n            "]],"start1":9565,"start2":9565,"length1":32,"length2":35}]],"length":11549,"saved":false}
{"ts":1377416953963,"patch":[[{"diffs":[[0,"**\r\n"],[-1,"             * Добавляем клавишу для тулбара, нажатие по которой заставит открыть диалог\r\n             */\r\n            editor.ui.addButton('Tezis', {\r\n                icon    : '/i/ico_btn_line.gif',\r\n                label   : 'Вставить тезис',\r\n                command : 'pl_cmd_dialog_tezis'\r\n            });\r\n            \r\n            /**\r\n"],[0,"    "]],"start1":7950,"start2":7950,"length1":351,"length2":8},{"diffs":[[0,"           });\r\n"],[1,"            \r\n            /**\r\n             * Добавляем клавишу для тулбара, нажатие по которой заставит открыть диалог\r\n             */\r\n            editor.ui.addButton('Tezis', {\r\n                icon    : '/i/ico_btn_line.gif',\r\n                label   : 'Вставить тезис',\r\n                command : 'pl_cmd_dialog_tezis'\r\n            });\r\n"],[0,"        }\r\n    }"]],"start1":11167,"start2":11167,"length1":32,"length2":375}]],"length":11549,"saved":false}
{"ts":1377416998987,"patch":[[{"diffs":[[0,"           /**\r\n"],[1,"             * ************* Команды редактора\r\n             */\r\n            /**\r\n"],[0,"             * С"]],"start1":7482,"start2":7482,"length1":32,"length2":114},{"diffs":[[0,"\r\n            \r\n"],[1,"            \r\n            /**\r\n             * ************* События\r\n             */\r\n            \r\n            \r\n"],[0,"            /**\r"]],"start1":8003,"start2":8003,"length1":32,"length2":146}]],"length":11745,"saved":false}
{"ts":1377417020402,"patch":[[{"diffs":[[0," {\r\n"],[-1,"            \r\n            /**\r\n             * Создаем команду для тулбара\r\n             * открывает диалог и посылает команду для добавления контента\r\n             */\r\n            editor.addCommand('pl_cmd_dialog_tezis', {\r\n                \r\n                exec: function (editor, data) {\r\n                    \r\n                    // определяем текущий элемент\r\n                    var sel = editor.getSelection(),\r\n                    element = sel.getStartElement();\r\n                    var insertMode;\r\n                    var tezis;\r\n                    \r\n                    // редактирование или добавление\r\n                    if (isDefined(data)) {\r\n                        \r\n                        tezis = $(data);\r\n                        if (!tezis.hasClass('line_head')) {\r\n                            \r\n                            tezis = tezis.parents('.line_head');\r\n                        }\r\n                        insertMode = false;\r\n                    } else if (element) {\r\n                        \r\n                        if ($(element['$']).hasClass('line_head')) {\r\n                            \r\n                            tezis = $(element['$']);\r\n                        } else {\r\n                            \r\n                            tezis = $(element['$']).parents('.line_head');\r\n                        }\r\n                        \r\n                        insertMode = element.data( 'cke-realelement' ) || !tezis.size();\r\n                    } else {\r\n                        \r\n                        insertMode = true;\r\n                    }\r\n                    \r\n                    if (insertMode) {\r\n                        \r\n                        // инициализация полей диалога значениями по умолчанию\r\n                        $('#' + editor.name).trigger('showTezis', [function(message){\r\n                            \r\n                            if ($.trim(message).length) {\r\n                                \r\n                                // посылаем команду для добавления контента\r\n                                editor.execCommand('pl_cmd_tezis', [message]);\r\n                            }\r\n                        }, '']);\r\n                    } else {\r\n                        \r\n                        // инициализация полей диалога значениями из текущего элемента\r\n                        $('#' + editor.name).trigger('showTezis', [function(message){\r\n                            \r\n                            if ($.trim(message).length) {\r\n                                \r\n                                tezis.find('p').text(message);\r\n                            }\r\n                        }, tezis.find('p').text()]);\r\n                    }\r\n                }\r\n            });\r\n            \r\n"],[0,"    "]],"start1":321,"start2":321,"length1":2770,"length2":8},{"diffs":[[0,"*/\r\n            "],[1,"/**\r\n             * Создаем команду для тулбара\r\n             * открывает диалог и посылает команду для добавления контента\r\n             */\r\n            editor.addCommand('pl_cmd_dialog_tezis', {\r\n                \r\n                exec: function (editor, data) {\r\n                    \r\n                    // определяем текущий элемент\r\n                    var sel = editor.getSelection(),\r\n                    element = sel.getStartElement();\r\n                    var insertMode;\r\n                    var tezis;\r\n                    \r\n                    // редактирование или добавление\r\n                    if (isDefined(data)) {\r\n                        \r\n                        tezis = $(data);\r\n                        if (!tezis.hasClass('line_head')) {\r\n                            \r\n                            tezis = tezis.parents('.line_head');\r\n                        }\r\n                        insertMode = false;\r\n                    } else if (element) {\r\n                        \r\n                        if ($(element['$']).hasClass('line_head')) {\r\n                            \r\n                            tezis = $(element['$']);\r\n                        } else {\r\n                            \r\n                            tezis = $(element['$']).parents('.line_head');\r\n                        }\r\n                        \r\n                        insertMode = element.data( 'cke-realelement' ) || !tezis.size();\r\n                    } else {\r\n                        \r\n                        insertMode = true;\r\n                    }\r\n                    \r\n                    if (insertMode) {\r\n                        \r\n                        // инициализация полей диалога значениями по умолчанию\r\n                        $('#' + editor.name).trigger('showTezis', [function(message){\r\n                            \r\n                            if ($.trim(message).length) {\r\n                                \r\n                                // посылаем команду для добавления контента\r\n                                editor.execCommand('pl_cmd_tezis', [message]);\r\n                            }\r\n                        }, '']);\r\n                    } else {\r\n                        \r\n                        // инициализация полей диалога значениями из текущего элемента\r\n                        $('#' + editor.name).trigger('showTezis', [function(message){\r\n                            \r\n                            if ($.trim(message).length) {\r\n                                \r\n                                tezis.find('p').text(message);\r\n                            }\r\n                        }, tezis.find('p').text()]);\r\n                    }\r\n                }\r\n            });"],[0,"\r\n            \r\n"]],"start1":5339,"start2":5339,"length1":32,"length2":2752}]],"length":11703,"saved":false}
{"ts":1377417030439,"patch":[[{"diffs":[[0,"            */\r\n"],[1,"\r\n"],[0,"            /**\r"]],"start1":5327,"start2":5327,"length1":32,"length2":34}]],"length":11705,"saved":false}
{"ts":1377417047206,"patch":[[{"diffs":[[0,"  \r\n"],[-1,"            \r\n            /**\r\n             * ************* События\r\n             */\r\n\r\n"],[0,"    "]],"start1":5253,"start2":5253,"length1":96,"length2":8},{"diffs":[[0,"           });\r\n"],[1,"\r\n"],[0,"            \r\n  "]],"start1":7975,"start2":7975,"length1":32,"length2":34},{"diffs":[[0,"\r\n            \r\n"],[1,"            /**\r\n             * ************* События\r\n             */\r\n\r\n"],[0,"            /**\r"]],"start1":7991,"start2":7991,"length1":32,"length2":106}]],"length":11693,"saved":false}
{"ts":1377417098938,"patch":[[{"diffs":[[0,"            */\r\n"],[1,"\r\n"],[0,"            /**\r"]],"start1":4785,"start2":4785,"length1":32,"length2":34}]],"length":11695,"saved":false}
