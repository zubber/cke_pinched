{"ts":1376830477586,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"$(document).ready(function(){\r\n\r\n    CKEDITOR.plugins.add('photo', {\r\n        \r\n        init : function(editor) {\r\n\r\n            /**\r\n             * получаем хтмл код описания\r\n             * @param title\r\n             */\r\n            var getTitleHtml = function(title) {\r\n\r\n                if (title) {\r\n                    return '<span contenteditable=\"false\" class=\"edit\"></span><p contenteditable=\"false\">' + title + '</p><div contenteditable=\"false\" class=\"clear_both\"></div>';\r\n                } else {\r\n                    return '<div contenteditable=\"false\" class=\"add_desc\"><a contenteditable=\"false\" href=\"#\"><span contenteditable=\"false\">Добавить описание фотографии</span></a></div>';\r\n                }\r\n            };\r\n\r\n            /**\r\n             * получаем хтмл код редактирования блока фото\r\n             * @param photoId\r\n             * @param src\r\n             * @param title\r\n             */\r\n            var getPhotoEditHtml = function(photoId, src, title) {\r\n\r\n                return '\\\r\n                    <div contenteditable=\"false\" rtckphotoid=\"' + photoId + '\" class=\"picture\" style=\"width:534px;\">\\\r\n                        <div contenteditable=\"false\" class=\"img\" style=\"background:url(' + src + ') no-repeat center center;height:363px;\">\\\r\n                            <span contenteditable=\"false\" class=\"del\">&nbsp;</span>\\\r\n                            <div contenteditable=\"false\" class=\"clear_both\">&nbsp;</div>\\\r\n                        </div>\\\r\n                        <div class=\"t\" contenteditable=\"false\" width=\"100%\">' + getTitleHtml(title) + '</div>\\\r\n                    </div>';\r\n            };\r\n\r\n            /**\r\n             * получаем внутренний хтмл код блока фото (в том виде, в котором он хранится в бд)\r\n             * @param photoId\r\n             * @param src\r\n             * @param title\r\n             */\r\n            var getPhotoInternalHtml = function(photoId, src, title) {\r\n\r\n                return '<placeholder type=\"photo\" photoid=\"' + photoId + '\" photosrc=\"' + src + '\" phototitle=\"' + title + '\">_</placeholder>';\r\n            };\r\n\r\n            /**\r\n             * @param e\r\n             */\r\n            var dataReadyHandler = function(e) {\r\n                if (isDefined(e.editor.document)) {\r\n\r\n                    //находим все блоки фото, сейчас они в внутреннем виде\r\n                    var placeholders = e.editor.document.getElementsByTag(\"placeholder\");\r\n                    var el;\r\n\r\n                    //для каждого\r\n                    for (var i = placeholders.count()-1; i >= 0; i--) {\r\n                        el = placeholders.getItem(i);\r\n\r\n                        if(el.getAttribute(\"type\") != \"photo\"){\r\n                            continue;\r\n                        }\r\n\r\n                        //выдираем нужные нам параметры из вёрстки\r\n                        var photoId = parseInt(el.getAttribute('photoid'));\r\n                        var src = el.getAttribute('photosrc');\r\n                        var title = el.getAttribute('phototitle');\r\n\r\n                        //заменяем блоки\r\n                        $(el['$']).replaceWith(getPhotoEditHtml(photoId, src, title));\r\n                    }\r\n\r\n                    //навесить ивенты\r\n                    preparePhotos();\r\n\r\n                }\r\n            };\r\n\r\n            /**\r\n             * подготовливаем блок редактирования фотографии\r\n             */\r\n            var preparePhotos = function() {\r\n\r\n                var jqDelPhotos = $(editor.document['$']).find('.picture .img .del');\r\n                var jqEditTitle = $(editor.document['$']).find('.picture span.edit, .picture .add_desc a, .picture p');\r\n\r\n                //редактирование фото\r\n                jqEditTitle.unbind('click').click(function() {\r\n\r\n                    var _selfFunc = arguments.callee;\r\n\r\n                    var e = $(this).parents('.picture');\r\n                    var title  = e.find('div.t p').text();\r\n                    var jqPopup = $('#add_desc_photo');\r\n                    var jqTextarea = jqPopup.find('textarea');\r\n\r\n                    //ввод текста\r\n                    jqTextarea.val(title || '').bind('focus keyup', function(){\r\n\r\n                        if ($(this).val().length >= 300) {\r\n                            $(this).val($(this).val().substr(0, 300))\r\n                            return false;\r\n                        }\r\n                    });\r\n\r\n                    //очищаем описание\r\n                    jqPopup.find('a.cancel').unbind('click').click(function() {\r\n                        jqPopup.find('textarea').val('');\r\n                        return false;\r\n                    });\r\n\r\n                    //устанавлвиаем описание\r\n                    jqPopup.find('a.choose').unbind('click').click(function(){\r\n                        var titleHtml = getTitleHtml($.trim(jqPopup.find('textarea').val().replace(/\\s+/gi,' ').replace(/\"+/gi, '').replace(/<\\/?[^>]+>|\\&[^;]+;/gi, '')));\r\n                        e.find('div.t').html(titleHtml);\r\n                        e.find('span.edit, .add_desc a, p').click(_selfFunc);\r\n                        jqPopup.hide();\r\n                        $('#overlay').remove();\r\n                        return false;\r\n                    });\r\n\r\n                    jqPopup.overlay().centering().show();\r\n                    jqTextarea.focus().setCursorPosition(jqTextarea.val().length);\r\n\r\n                    return false;\r\n                });\r\n\r\n                //удаление фото\r\n                jqDelPhotos.unbind('click').click(function(){\r\n\r\n                    var element = $(this).parents('.picture');\r\n                    confirm('Вы действительно хотите удалить данную фотографию из заметки?', function(result){\r\n\r\n                        if (result) {\r\n\r\n                            element.remove();\r\n                        }\r\n                    }, undefined, undefined, 'Создание заметки');\r\n\r\n                    return false;\r\n                });\r\n            };\r\n\r\n            //команда вызова диалога \"селектора фото\"\r\n            editor.addCommand('rt_cmd_dlg_photo_selector', {\r\n\r\n                exec: function(editor) {\r\n\r\n                    window.photoSelector.display({\r\n                        'isSinglePhotoSelection': true,\r\n                        'onSelectHandler': function(photos) {\r\n\r\n                            if (!photos.length) {\r\n                                return;\r\n                            }\r\n\r\n                            // посылаем команду для добавления контента\r\n                            editor.execCommand('rt_cmd_photo', photos[0]);\r\n                            \r\n                            // инициализация полей диалога значениями по умолчанию\r\n                            $('#' + editor.name).trigger('addGeo', [photos[0]]);\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n\r\n            //добавление фото в едитор\r\n            editor.addCommand('rt_cmd_photo', {\r\n\r\n                exec: function(editor, photo) {\r\n\r\n                    //заменяем размеры и получаем нужный размер фото\r\n                    photo.src = photo.src.replace('60x60', '534x363');\r\n\r\n                    //обработчик загрузки фото\r\n                    var handler = function() {\r\n                        $(editor.document['$']).find('div[rtckphotoid=' + photo.id + '] div.img').css('background-image', 'url(' + photo.src + ')');\r\n                    };\r\n\r\n                    editor.insertHtml(getPhotoEditHtml(photo.id, '/i/ajaxLoading.gif'));\r\n\r\n                    editor.fire(\"clearEmptyP\");\r\n\r\n                    //загружаем фото, и по окончанию загрузки обрабыбатываем\r\n                    $(new Image()).load(handler).attr('src', photo.src);\r\n                }\r\n            });\r\n\r\n            //добавляем кнопку в интерфейс\r\n            editor.ui.addButton('rtPhoto', {\r\n                icon    : '/i/ico_btn_img.gif',\r\n                label   : 'Вставить фото',\r\n                command : 'rt_cmd_dlg_photo_selector'\r\n            });\r\n\r\n            editor.on('rtUpdateControls', preparePhotos);\r\n\r\n            /**\r\n             * событие происходит при загрузка едитора, после добавлених хтмл-кода в элемент\r\n             * нам теперь нужно, заменить внутренний вид на тот, что используется в эдиторе\r\n             * и навесить события\r\n             */\r\n            editor.on('instanceReady', dataReadyHandler);\r\n\r\n            /**\r\n             * перед тем как отдать данные для сохранения, нам нужно\r\n             * подменить вёрстку всех блоков на внутреннюю\r\n             */\r\n            editor.on('beforeGetData', function(e){\r\n\r\n                if (isDefined(e.editor.document)) {\r\n\r\n                    //находим все блоки фото, сейчас они в редактируемом виде\r\n                    var jqPhotoBlocks = $(e.editor.document['$']).find('div.picture');\r\n\r\n                    //для каждого\r\n                    jqPhotoBlocks.each(function(i, e) {\r\n                        var jqElement = $(e);\r\n\r\n                        //выдираем нужные нам параметры из вёрстки\r\n                        var photoId = parseInt(jqElement.attr('rtckphotoid'));\r\n                        var src = jqElement.find('div.img').css('background-image').\r\n                                replace('url(', '').replace(')', '').replace(/\"/g, ''). //убираем обёртку бэкгроунда\r\n                                replace(window.location.protocol+'//'+window.location.hostname, ''); //убираем путь хоста\r\n                                // , т.к. можно сохранить на локальном, а если смотреть с теста, будет ничего не видно\r\n                        var title = (jqElement.find('div.t p').text() || '').substr(0, 300); //обрезаем длину\r\n\r\n                        //подставляем заменяющий блок перед заменяемый, который после грохаем\r\n                        jqElement.before(getPhotoInternalHtml(photoId, src, title));\r\n                        jqElement.remove();\r\n                    });\r\n                }\r\n            });\r\n\r\n            /**\r\n             * событие происходит после того, как отдали данные на сохранение, теперь нужно провести обратную замену на редактируемый вид\r\n             * и снова навесить события\r\n             */\r\n            editor.on('getData', dataReadyHandler);\r\n\r\n            /**\r\n             * возвращаем события при Ctrl-Z\r\n             */\r\n            editor.on('key', function(e){\r\n                if (isDefined(e.editor.document) && CKEDITOR.CTRL + 90 == e.data.keyCode) {//Ctrl-Z\r\n                    setTimeout(function(){\r\n                        preparePhotos();\r\n                    }, 100);\r\n                }\r\n            });\r\n        }\r\n    });\r\n});"]],"start1":0,"start2":0,"length1":0,"length2":10661}]],"length":10661}
{"contributors":[],"silentsave":false,"ts":1377330654732,"patch":[[{"diffs":[[0," длину\r\n"],[-1,"\r\n"],[0,"        "]],"start1":9694,"start2":9694,"length1":18,"length2":16}]],"length":10659,"saved":false}
{"ts":1377330657598,"patch":[[{"diffs":[[0,"ну\r\n"],[-1,"                        "],[1,"\r\n"],[0,"//по"]],"start1":9698,"start2":9698,"length1":32,"length2":10}]],"length":10637,"saved":false}
{"ts":1377330659678,"patch":[[{"diffs":[[0,"лину\r\n\r\n"],[1,"                        "],[0,"//подста"]],"start1":9696,"start2":9696,"length1":16,"length2":40}]],"length":10661,"saved":false}
{"ts":1377333376933,"patch":[[{"diffs":[[0,"ocument."],[1,"$."],[0,"getEleme"]],"start1":2390,"start2":2390,"length1":16,"length2":18},{"diffs":[[0,"ntsByTag"],[1,"Name"],[0,"(\"placeh"]],"start1":2408,"start2":2408,"length1":16,"length2":20}]],"length":10667,"saved":false}
{"ts":1377333426313,"patch":[[{"diffs":[[0,"ocument."],[-1,"$."],[0,"getEleme"]],"start1":2390,"start2":2390,"length1":18,"length2":16},{"diffs":[[0,"yTag"],[-1,"Name"],[0,"(\"pl"]],"start1":2410,"start2":2410,"length1":12,"length2":8}]],"length":10661,"saved":false}
